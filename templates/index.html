<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rerun Server</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --bg-primary: #0f1113;
            --bg-secondary: #171a1d;
            --bg-tertiary: #1f2327;
            --bg-logs: #111417;
            --text-primary: #e6e8ea;
            --text-secondary: #9aa0a6;
            --border-color: #2c3136;
            --success-color: #1a7f37;
            --danger-color: #c0353a;
            --warning-color: #f59e0b;
            --info-color: #58a6ff;
        }
        
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .container {
            max-width: 1200px;
            margin-top: 40px;
            padding: 28px;
            background-color: var(--bg-secondary);
            border-radius: 14px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.4);
        }
        
        h1 {
            font-size: 1.6rem;
            font-weight: 600;
        }
        
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .hint {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        .btn-start {
            background-color: var(--success-color);
            color: #fff;
            border: none;
        }
        
        .btn-start:hover {
            background-color: #22863a;
            color: #fff;
        }
        
        .btn-stop {
            background-color: var(--danger-color);
            color: #fff;
            border: none;
        }
        
        .btn-stop:hover {
            background-color: #d73a49;
            color: #fff;
        }
        
        select, input {
            background-color: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        select:focus, input:focus {
            background-color: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
            border-color: var(--success-color) !important;
            box-shadow: 0 0 0 0.25rem rgba(26, 127, 55, 0.25) !important;
        }
        
        .logs {
            background-color: var(--bg-logs);
            border: 1px solid var(--border-color);
            padding: 15px;
            height: 280px;
            overflow-y: auto;
            border-radius: 8px;
            margin-top: 20px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.875rem;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 10px;
            transition: all 0.3s ease;
        }
        
        .dot.online {
            background-color: var(--success-color);
            box-shadow: 0 0 10px rgba(26,127,55,0.8);
            animation: pulse 2s infinite;
        }
        
        .dot.offline {
            background-color: #555b61;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(26,127,55,0.7); }
            70% { box-shadow: 0 0 0 10px rgba(26,127,55,0); }
            100% { box-shadow: 0 0 0 0 rgba(26,127,55,0); }
        }
        
        .alert {
            border: none;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .alert-danger {
            background-color: rgba(192, 53, 58, 0.1);
            color: #f85149;
            border-left: 4px solid var(--danger-color);
        }
        
        .alert-success {
            background-color: rgba(26, 127, 55, 0.1);
            color: #56d364;
            border-left: 4px solid var(--success-color);
        }
        
        /* Destination management styles */
        .destination-row {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .destination-counter {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .destination-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .destination-inputs input {
            flex: 1;
        }
        
        .btn-add-destination {
            background-color: var(--success-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-add-destination:hover {
            background-color: #22863a;
        }
        
        .btn-remove-destination {
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 10px;
        }
        
        .btn-remove-destination:hover {
            background-color: #d73a49;
        }
        
        @media (max-width: 768px) {
            .container {
                margin-top: 20px;
                padding: 20px;
            }
            
            .logs {
                height: 200px;
            }
            
            .destination-inputs {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="status-bar">
            <div>
                <h1 class="m-0">
                    Rerun 24/7
                    <span id="status-dot" class="dot offline" title="Offline"></span>
                </h1>
                <div class="stats mt-1">
                    <span id="stats-text">Ready to stream</span>
                </div>
            </div>
            <div class="text-end">
                <div class="hint">
                    <strong>GPU Support:</strong><br>
                    NVIDIA<span class="badge bg-success ms-1">NVENC</span>
                    Intel<span class="badge bg-info ms-1">VAAPI</span>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <h4>Stream Destinations</h4>
                <div class="hint mb-3">Configure streaming URLs and keys for multiple platforms</div>
                
                <div id="destinations-container">
                    <!-- Dynamic destinations will be populated here -->
                </div>
                
                <div class="d-flex gap-2 mb-4">
                    <button type="button" class="btn-add-destination" id="add-destination-btn" title="Add another destination">
                        +
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="saveDestinations()">
                        <i class="bi bi-save"></i> Save Destinations
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="resetDestinations()">
                        <i class="bi bi-arrow-clockwise"></i> Reset to Defaults
                    </button>
                </div>
            </div>
            
            <div class="col-md-6">
                <h4>Stream Configuration</h4>
                
                <form id="stream-form" class="mt-3">
                    <div class="row g-3">
                        <!-- Bitrate -->
                        <div class="col-md-6">
                            <label for="bitrate" class="form-label">Video Bitrate</label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="bitrate" 
                                name="bitrate"
                                placeholder="2500k" 
                                value="2500k"
                                pattern="^\d+k?$"
                                title="Enter bitrate like '2500k' or '2500'"
                            >
                            <div class="hint">Format: 2500k or 2500</div>
                        </div>
                        <!-- Input Type -->
                        <div class="col-md-6">
                            <label for="input_type" class="form-label">Input Source</label>
                            <select class="form-select" id="input_type" name="input_type">
                                <option value="file" selected>Local Video File</option>
                                <option value="srt">SRT / RTMP Stream</option>
                            </select>
                        </div>
                        <!-- Video Selection (for file input) -->
                        <div class="col-12" id="video-selection">
                            <label for="video" class="form-label">Select Video File</label>
                            <select class="form-select" id="video" name="video">
                                <option value="">Loading videos...</option>
                            </select>
                            <div class="hint">Upload videos to the configured video folder</div>
                        </div>
                        <!-- SRT URL (for stream input) -->
                        <div class="col-12" id="srt-input" style="display:none;">
                            <label for="srt_url" class="form-label">SRT / RTMP Input URL</label>
                            <input 
                                type="url" 
                                class="form-control" 
                                id="srt_url" 
                                name="srt_url"
                                placeholder="srt://host:port?streamid=publish/live/stream_key"
                                value=""
                            >
                            <div class="hint">Enter the full SRT or RTMP input URL</div>
                        </div>
                        <!-- Encoder -->
                        <div class="col-md-6">
                            <label for="encoder" class="form-label">Video Encoder</label>
                            <select class="form-select" id="encoder" name="encoder">
                                <option value="libx264" selected>CPU (x264)</option>
                                <option value="h264_nvenc">NVIDIA GPU (NVENC)</option>
                                <option value="h264_vaapi">Intel iGPU (VAAPI)</option>
                            </select>
                            <div class="hint mt-1" id="encoder-help">CPU encoding works on all systems</div>
                        </div>
                        <!-- Preset -->
                        <div class="col-md-6">
                            <label for="preset" class="form-label">Encoder Preset</label>
                            <select class="form-select" id="preset" name="preset">
                                <!-- Options will be populated by JavaScript -->
                            </select>
                            <div class="hint mt-1" id="preset-help">Preset affects encoding speed vs quality</div>
                        </div>
                        <!-- Shuffle Mode -->
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="shuffle_mode" name="shuffle_mode" checked>
                                <label class="form-check-label" for="shuffle_mode">Shuffle Playlist</label>
                            </div>
                            <div class="hint">Randomly play videos from your library</div>
                        </div>
                    </div>
                    <!-- Control Buttons -->
                    <div class="d-flex gap-2 mt-4">
                        <button id="toggle-btn" type="button" class="btn btn-start px-4">
                            <span id="toggle-text">Start Stream</span>
                        </button>
                        <button id="skip-btn" type="button" class="btn btn-outline-warning" disabled>
                            <i class="bi bi-skip-forward"></i> Skip Video
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearLogs()">
                            <i class="bi bi-trash"></i> Clear Logs
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Error/Success Messages -->
        <div id="messages"></div>
        <!-- Logs -->
        <div class="logs" id="logs"></div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // DOM elements
            const form = document.getElementById("stream-form");
            const inputType = document.getElementById("input_type");
            const videoSelection = document.getElementById("video-selection");
            const srtInput = document.getElementById("srt-input");
            const encoder = document.getElementById("encoder");
            const preset = document.getElementById("preset");
            const encoderHelp = document.getElementById("encoder-help");
            const presetHelp = document.getElementById("preset-help");
            const statusDot = document.getElementById("status-dot");
            const statsText = document.getElementById("stats-text");
            const logsEl = document.getElementById("logs");
            const toggleBtn = document.getElementById("toggle-btn");
            const toggleText = document.getElementById("toggle-text");
            const skipBtn = document.getElementById("skip-btn");
            const messagesDiv = document.getElementById("messages");
            const destinationsContainer = document.getElementById("destinations-container");
            const addDestinationBtn = document.getElementById("add-destination-btn");
            const shuffleMode = document.getElementById("shuffle_mode");

            // Dynamic destinations management
            let destinations = [];
            let nextId = 5;

            // Preset configurations
            const PRESET_OPTIONS = {
                "libx264": {
                    "ultrafast": "Ultra Fast (lowest quality)",
                    "superfast": "Super Fast",
                    "veryfast": "Very Fast",
                    "faster": "Faster",
                    "fast": "Fast",
                    "medium": "Medium (balanced)",
                    "slow": "Slow (better quality)",
                    "slower": "Slower",
                    "veryslow": "Very Slow (best quality)"
                },
                "h264_nvenc": {
                    "p1": "P1 (fastest)",
                    "p2": "P2",
                    "p3": "P3",
                    "p4": "P4 (balanced)",
                    "p5": "P5",
                    "p6": "P6",
                    "p7": "P7 (best quality)",
                    "ll": "Low Latency",
                    "llhp": "LL High Performance",
                    "llhq": "LL High Quality"
                },
                "h264_vaapi": {
                    "medium": "Medium (default)",
                    "fast": "Fast",
                    "slow": "Slow"
                }
            };

            const DEFAULT_PRESETS = {
                "libx264": "medium",
                "h264_nvenc": "p4",
                "h264_vaapi": "medium"
            };

            const ENCODER_HELP = {
                "libx264": "CPU encoding: slower presets = better quality",
                "h264_nvenc": "NVIDIA GPU encoding: P1-P7 for speed→quality, LL* for low latency",
                "h264_vaapi": "Intel GPU encoding: efficient for streaming"
            };

            // Load destinations from backend on page load
            async function loadDestinations() {
                try {
                    const response = await fetch("/destinations");
                    const data = await response.json();
                    
                    if (data.destinations && data.destinations.length > 0) {
                        destinations = data.destinations.map(dest => ({
                            id: dest.id,
                            url: dest.url || "",
                            key: dest.key || "",
                            enabled: dest.enabled || false
                        }));
                    } else {
                        // Initialize with default destinations if none exist
                        destinations = [
                            { id: 1, url: "rtmp://live.twitch.tv/app/", key: "", enabled: false },
                            { id: 2, url: "rtmp://a.rtmp.youtube.com/live2/", key: "", enabled: false },
                            { id: 3, url: "rtmps://live-api-s.facebook.com:443/rtmp/", key: "", enabled: false },
                            { id: 4, url: "rtmp://rtmp.kick.com:1935/live/", key: "", enabled: false }
                        ];
                    }
                    renderDestinations();
                } catch (error) {
                    console.error("Failed to load destinations:", error);
                    // Initialize with defaults if loading fails
                    destinations = [
                        { id: 1, url: "rtmp://live.twitch.tv/app/", key: "", enabled: false },
                        { id: 2, url: "rtmp://a.rtmp.youtube.com/live2/", key: "", enabled: false },
                        { id: 3, url: "rtmps://live-api-s.facebook.com:443/rtmp/", key: "", enabled: false },
                        { id: 4, url: "rtmp://rtmp.kick.com:1935/live/", key: "", enabled: false }
                    ];
                    renderDestinations();
                }
            }

            // Load videos from backend
            async function loadVideos() {
                try {
                    const response = await fetch("/videos");
                    const data = await response.json();
                    const videoSelect = document.getElementById("video");
                    
                    videoSelect.innerHTML = "";
                    
                    if (data.videos && data.videos.length > 0) {
                        data.videos.forEach(video => {
                            const option = document.createElement("option");
                            option.value = video;
                            option.textContent = video;
                            videoSelect.appendChild(option);
                        });
                    } else {
                        const option = document.createElement("option");
                        option.value = "";
                        option.textContent = "No videos found";
                        videoSelect.appendChild(option);
                    }
                } catch (error) {
                    console.error("Failed to load videos:", error);
                    const videoSelect = document.getElementById("video");
                    videoSelect.innerHTML = '<option value="">Error loading videos</option>';
                }
            }

            // Destination management functions
            function renderDestinations() {
                destinationsContainer.innerHTML = '';
                
                destinations.forEach((dest, index) => {
                    const destDiv = document.createElement('div');
                    destDiv.className = 'destination-row';
                    destDiv.dataset.id = dest.id;
                    
                    destDiv.innerHTML = `
                        <div class="destination-counter">Destination ${index + 1}</div>
                        ${destinations.length > 1 ? '<button type="button" class="btn-remove-destination" onclick="removeDestination(' + index + ')">×</button>' : ''}
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input destination-enabled" type="checkbox" 
                                   id="dest-${dest.id}-enabled" ${dest.enabled ? 'checked' : ''}>
                            <label class="form-check-label" for="dest-${dest.id}-enabled">Enable this destination</label>
                        </div>
                        <div class="destination-inputs">
                            <input type="url" class="form-control destination-url" 
                                   placeholder="rtmp://live.platform.com/app/" 
                                   value="${dest.url}">
                            <input type="text" class="form-control destination-key" 
                                   placeholder="Stream key" 
                                   value="${dest.key}">
                        </div>
                    `;
                    
                    destinationsContainer.appendChild(destDiv);
                    
                    // Add event listeners
                    const enabledCheckbox = destDiv.querySelector('.destination-enabled');
                    const urlInput = destDiv.querySelector('.destination-url');
                    const keyInput = destDiv.querySelector('.destination-key');
                    
                    enabledCheckbox.addEventListener('change', (e) => {
                        destinations[index].enabled = e.target.checked;
                    });
                    
                    urlInput.addEventListener('input', (e) => {
                        destinations[index].url = e.target.value;
                    });
                    
                    keyInput.addEventListener('input', (e) => {
                        destinations[index].key = e.target.value;
                    });
                });
            }

            function addDestination() {
                destinations.push({
                    id: nextId++,
                    url: "",
                    key: "",
                    enabled: false
                });
                renderDestinations();
            }

            function removeDestination(index) {
                if (destinations.length > 1) {
                    destinations.splice(index, 1);
                    renderDestinations();
                }
            }

            // Make removeDestination globally available
            window.removeDestination = removeDestination;

            // Save destinations
            window.saveDestinations = async function() {
                try {
                    const response = await fetch("/destinations", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(destinations.map((dest, index) => ({
                            id: dest.id.toString(),
                            name: `Destination ${index + 1}`,
                            url: dest.url,
                            key: dest.key,
                            enabled: dest.enabled,
                            type: dest.url.includes('rtmps://') ? 'rtmps' : 'rtmp',
                            status: dest.enabled && dest.key ? 'active' : 'inactive'
                        })))
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        showMessage(data.error || "Failed to save destinations", "danger");
                    } else {
                        showMessage("Destinations saved successfully", "success");
                    }
                } catch (error) {
                    showMessage("Network error: " + error.message, "danger");
                }
            };

            // Reset destinations
            window.resetDestinations = function() {
                if (confirm("Reset all destinations to default settings?")) {
                    destinations = [
                        { id: 1, url: "rtmp://live.twitch.tv/app/", key: "", enabled: false },
                        { id: 2, url: "rtmp://a.rtmp.youtube.com/live2/", key: "", enabled: false },
                        { id: 3, url: "rtmps://live-api-s.facebook.com:443/rtmp/", key: "", enabled: false },
                        { id: 4, url: "rtmp://rtmp.kick.com:1935/live/", key: "", enabled: false }
                    ];
                    nextId = 5;
                    renderDestinations();
                    showMessage("Destinations reset to defaults", "success");
                }
            };

            // Utility functions
            function showMessage(message, type = 'danger') {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" aria-label="Close" onclick="this.parentElement.remove()"></button>
                `;
                messagesDiv.appendChild(alertDiv);
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }

            function clearMessages() {
                messagesDiv.innerHTML = '';
            }

            function validateForm() {
                const bitrate = document.getElementById('bitrate').value.trim();
                const inputTypeVal = inputType.value;
                const srtUrl = document.getElementById('srt_url').value.trim();

                // Check if at least one destination is enabled
                const enabledDestinations = destinations.filter(dest => dest.enabled && dest.url && dest.key);
                if (enabledDestinations.length === 0) {
                    showMessage('At least one destination must be enabled with both URL and stream key');
                    return false;
                }

                if (!bitrate.match(/^\d+k?$/)) {
                    showMessage('Invalid bitrate format. Use format like "2500k" or "2500"');
                    return false;
                }

                if (inputTypeVal === 'srt' && !srtUrl) {
                    showMessage('SRT/RTMP input URL is required when using stream input');
                    return false;
                }

                return true;
            }

            function toggleInputDisplay() {
                if (inputType.value === "file") {
                    videoSelection.style.display = "block";
                    srtInput.style.display = "none";
                } else {
                    videoSelection.style.display = "none";
                    srtInput.style.display = "block";
                }
            }

            function populatePresets() {
                const encoderVal = encoder.value;
                const options = PRESET_OPTIONS[encoderVal] || {};
                
                preset.innerHTML = "";
                
                Object.entries(options).forEach(([value, label]) => {
                    const option = document.createElement("option");
                    option.value = value;
                    option.textContent = label;
                    preset.appendChild(option);
                });

                const defaultPreset = DEFAULT_PRESETS[encoderVal] || "medium";
                preset.value = defaultPreset;

                encoderHelp.textContent = ENCODER_HELP[encoderVal] || "";
                presetHelp.textContent = `Selected: ${options[preset.value] || preset.value}`;
            }

            function updateStats(data) {
                if (data.running) {
                    const uptime = data.uptime ? Math.floor(data.uptime / 60) : 0;
                    const restarts = data.restarts || 0;
                    const videoInfo = data.current_video ? ` • Now playing: ${data.current_video}` : '';
                    statsText.textContent = `Streaming to ${data.enabled_destinations} platforms • ${uptime}m uptime • ${restarts} restarts${videoInfo}`;
                    skipBtn.disabled = false;
                } else {
                    const videoCount = data.video_count || 0;
                    const enabledCount = destinations.filter(d => d.enabled).length;
                    statsText.textContent = `Ready to stream • ${videoCount} videos available • ${enabledCount} destinations enabled`;
                    skipBtn.disabled = true;
                }
                shuffleMode.checked = data.shuffle_mode || false;
            }

            // API functions
            async function pollStatus() {
                try {
                    const response = await fetch("/status");
                    const data = await response.json();
                    
                    updateStats(data);
                    
                    if (data.running) {
                        statusDot.classList.remove("offline");
                        statusDot.classList.add("online");
                        statusDot.title = "Streaming";
                        toggleText.textContent = "Stop Stream";
                        toggleBtn.classList.remove("btn-start");
                        toggleBtn.classList.add("btn-stop");
                    } else {
                        statusDot.classList.remove("online");
                        statusDot.classList.add("offline");
                        statusDot.title = "Offline";
                        toggleText.textContent = "Start Stream";
                        toggleBtn.classList.remove("btn-stop");
                        toggleBtn.classList.add("btn-start");
                    }
                } catch (error) {
                    console.error("Failed to get status:", error);
                }
            }

            async function pollLogs() {
                try {
                    const response = await fetch("/logs");
                    const data = await response.json();
                    const lines = data.lines || [];
                    
                    logsEl.textContent = lines.join("\n");
                    logsEl.scrollTop = logsEl.scrollHeight;
                } catch (error) {
                    console.error("Failed to get logs:", error);
                }
            }

            async function skipVideo() {
                try {
                    const response = await fetch("/skip", {
                        method: "POST"
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        showMessage(data.error || "Failed to skip video", "danger");
                    } else {
                        showMessage("Skipping to next video", "success");
                        await pollStatus();
                    }
                } catch (error) {
                    showMessage("Network error: " + error.message, "danger");
                }
            }

            async function toggleShuffle() {
                try {
                    const response = await fetch("/shuffle", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ shuffle: shuffleMode.checked })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        showMessage(data.error || "Failed to toggle shuffle", "danger");
                        shuffleMode.checked = !shuffleMode.checked;
                    } else {
                        showMessage(`Shuffle mode ${data.shuffle ? 'enabled' : 'disabled'}`, "success");
                    }
                } catch (error) {
                    showMessage("Network error: " + error.message, "danger");
                    shuffleMode.checked = !shuffleMode.checked;
                }
            }

            // Event listeners
            addDestinationBtn.addEventListener("click", addDestination);
            
            toggleBtn.addEventListener("click", async function() {
                if (!validateForm()) return;
                
                clearMessages();
                try {
                    toggleBtn.disabled = true;
                    
                    const formData = new FormData(form);
                    
                    // Add destination data to form
                    destinations.forEach((dest, index) => {
                        formData.append(`dest_${dest.id}_enabled`, dest.enabled ? 'on' : '');
                        formData.append(`dest_${dest.id}_key`, dest.key);
                    });
                    
                    const response = await fetch("/toggle", {
                        method: "POST",
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        showMessage(data.error || "Failed to toggle stream", "danger");
                    } else {
                        showMessage(data.message || "Stream toggled", "success");
                    }
                    
                    await pollStatus();
                    await pollLogs();
                    
                } catch (error) {
                    showMessage("Network error: " + error.message, "danger");
                } finally {
                    toggleBtn.disabled = false;
                }
            });

            skipBtn.addEventListener("click", skipVideo);
            shuffleMode.addEventListener("change", toggleShuffle);
            encoder.addEventListener("change", populatePresets);
            inputType.addEventListener("change", toggleInputDisplay);
            
            preset.addEventListener("change", function() {
                const options = PRESET_OPTIONS[encoder.value] || {};
                presetHelp.textContent = `Selected: ${options[preset.value] || preset.value}`;
            });

            // Global functions
            window.clearLogs = function() {
                logsEl.textContent = "";
            };

            // Initialize everything
            loadDestinations(); // Load saved destinations from backend
            loadVideos(); // Load video list from backend
            toggleInputDisplay();
            populatePresets();
            
            // Refresh videos periodically
            setInterval(loadVideos, 10000); // Refresh every 10 seconds
            
            // Start polling
            pollStatus();
            pollLogs();
            setInterval(pollStatus, 3000);
            setInterval(pollLogs, 2000);
        });
    </script>
</body>
</html>
