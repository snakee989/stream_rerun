<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rerun 24/7 Streaming</title>
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
        script-src 'self' 'unsafe-inline';
        connect-src 'self';
        font-src https://cdn.jsdelivr.net;
    ">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f1113;
            --bg-secondary: #171a1d;
            --bg-tertiary: #1f2327;
            --bg-logs: #111417;
            --text-primary: #e6e8ea;
            --text-secondary: #9aa0a6;
            --border-color: #2c3136;
            --success-color: #1a7f37;
            --danger-color: #c0353a;
            --warning-color: #f59e0b;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .container {
            max-width: 900px;
            margin-top: 40px;
            padding: 28px;
            background-color: var(--bg-secondary);
            border-radius: 14px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.4);
        }

        h1 {
            font-size: 1.6rem;
            font-weight: 600;
        }

        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .hint {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .btn-start {
            background-color: var(--success-color);
            color: #fff;
            border: none;
        }

        .btn-start:hover {
            background-color: #22863a;
            color: #fff;
        }

        .btn-stop {
            background-color: var(--danger-color);
            color: #fff;
            border: none;
        }

        .btn-stop:hover {
            background-color: #d73a49;
            color: #fff;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading::after {
            content: "";
            width: 16px;
            height: 16px;
            margin-left: 8px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        select, input {
            background-color: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
        }

        select:focus, input:focus {
            background-color: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
            border-color: var(--success-color) !important;
            box-shadow: 0 0 0 0.25rem rgba(26, 127, 55, 0.25) !important;
        }

        .logs {
            background-color: var(--bg-logs);
            border: 1px solid var(--border-color);
            padding: 15px;
            height: 280px;
            overflow-y: auto;
            border-radius: 8px;
            margin-top: 20px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.875rem;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .logs::-webkit-scrollbar {
            width: 8px;
        }

        .logs::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .logs::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .logs::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .dot.online {
            background-color: var(--success-color);
            box-shadow: 0 0 10px rgba(26,127,55,0.8);
            animation: pulse 2s infinite;
        }

        .dot.offline {
            background-color: #555b61;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(26,127,55,0.7); }
            70% { box-shadow: 0 0 0 10px rgba(26,127,55,0); }
            100% { box-shadow: 0 0 0 0 rgba(26,127,55,0); }
        }

        .alert {
            border: none;
            border-radius: 8px;
            margin-top: 15px;
        }

        .alert-danger {
            background-color: rgba(192, 53, 58, 0.1);
            color: #f85149;
            border-left: 4px solid var(--danger-color);
        }

        .alert-success {
            background-color: rgba(26, 127, 55, 0.1);
            color: #56d364;
            border-left: 4px solid var(--success-color);
        }

        .stats {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .form-row {
            margin-bottom: 1rem;
        }

        .encoder-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 8px;
        }

        .encoder-badge.cpu { background-color: rgba(59, 130, 246, 0.2); color: #93c5fd; }
        .encoder-badge.gpu { background-color: rgba(16, 185, 129, 0.2); color: #6ee7b7; }
        .encoder-badge.unavailable { background-color: rgba(156, 163, 175, 0.2); color: #9ca3af; }

        @media (max-width: 768px) {
            .container {
                margin-top: 20px;
                padding: 20px;
            }
            
            .logs {
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="status-bar">
            <div>
                <h1 class="m-0">
                    Rerun 24/7 Streaming
                    <span id="status-dot" class="dot offline" title="Offline"></span>
                </h1>
                <div class="stats mt-1">
                    <span id="stats-text">Ready to stream</span>
                </div>
            </div>
            <div class="text-end">
                <div class="hint">
                    <strong>GPU Support:</strong><br>
                    NVIDIA<span class="encoder-badge gpu">NVENC</span>
                    Intel<span class="encoder-badge gpu">VAAPI</span>
                </div>
            </div>
        </div>

        <form id="stream-form" class="mt-3">
            <div class="row g-3">
                <!-- Stream Key -->
                <div class="col-12">
                    <label for="stream_key" class="form-label">
                        Stream Key / Output URL
                        <span class="text-danger">*</span>
                    </label>
                    <input 
                        type="text" 
                        class="form-control" 
                        id="stream_key" 
                        name="stream_key"
                        placeholder="rtmp://live.twitch.tv/app/YOUR_STREAM_KEY"
                        value="{{ form.stream_key }}"
                        required
                    >
                    <div class="hint">
                        Examples: <code>rtmp://live.twitch.tv/app/KEY</code> or <code>srt://host:port?streamid=...</code>
                    </div>
                </div>

                <!-- Bitrate -->
                <div class="col-md-4">
                    <label for="bitrate" class="form-label">Video Bitrate</label>
                    <input 
                        type="text" 
                        class="form-control" 
                        id="bitrate" 
                        name="bitrate"
                        placeholder="2500k" 
                        value="{{ form.bitrate }}"
                        pattern="^\d+k?$"
                        title="Enter bitrate like '2500k' or '2500'"
                    >
                    <div class="hint">Format: 2500k or 2500</div>
                </div>

                <!-- Input Type -->
                <div class="col-md-4">
                    <label for="input_type" class="form-label">Input Source</label>
                    <select class="form-select" id="input_type" name="input_type">
                        <option value="file" {% if form.input_type=='file' %}selected{% endif %}>Local Video File</option>
                        <option value="srt" {% if form.input_type=='srt' %}selected{% endif %}>SRT / RTMP Stream</option>
                    </select>
                </div>

                <!-- Encoder -->
                <div class="col-md-4">
                    <label for="encoder" class="form-label">Video Encoder</label>
                    <select class="form-select" id="encoder" name="encoder">
                        <option value="libx264" {% if form.encoder=='libx264' %}selected{% endif %}>
                            CPU (x264)<span class="encoder-badge cpu">STABLE</span>
                        </option>
                        <option value="h264_nvenc" {% if form.encoder=='h264_nvenc' %}selected{% endif %}>
                            NVIDIA GPU (NVENC)<span class="encoder-badge gpu">FAST</span>
                        </option>
                        <option value="h264_vaapi" {% if form.encoder=='h264_vaapi' %}selected{% endif %}>
                            Intel iGPU (VAAPI)<span class="encoder-badge gpu">EFFICIENT</span>
                        </option>
                    </select>
                    <div class="hint mt-1" id="encoder-help">CPU encoding works on all systems</div>
                </div>

                <!-- Video Selection (for file input) -->
                <div class="col-md-8" id="video-selection">
                    <label for="video" class="form-label">Select Video File</label>
                    <select class="form-select" id="video" name="video">
                        {% if videos %}
                            {% for v in videos %}
                                <option value="{{v}}" {% if form.video==v %}selected{% endif %}>{{v}}</option>
                            {% endfor %}
                        {% else %}
                            <option value="">No video files found</option>
                        {% endif %}
                    </select>
                    <div class="hint">Upload videos to the configured video folder</div>
                </div>

                <!-- SRT URL (for stream input) -->
                <div class="col-md-8" id="srt-input" style="display:none;">
                    <label for="srt_url" class="form-label">SRT / RTMP Input URL</label>
                    <input 
                        type="url" 
                        class="form-control" 
                        id="srt_url" 
                        name="srt_url"
                        placeholder="srt://host:port?streamid=publish/live/stream_key"
                        value="{{ form.srt_url }}"
                    >
                    <div class="hint">Enter the full SRT or RTMP input URL</div>
                </div>

                <!-- Preset -->
                <div class="col-md-4">
                    <label for="preset" class="form-label">Encoder Preset</label>
                    <select class="form-select" id="preset" name="preset">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                    <div class="hint mt-1" id="preset-help">Preset affects encoding speed vs quality</div>
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="d-flex gap-2 mt-4">
                <button id="toggle-btn" type="button" class="btn btn-start px-4">
                    <span id="toggle-text">Start Stream</span>
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="clearLogs()">
                    Clear Logs
                </button>
            </div>
        </form>

        <!-- Error/Success Messages -->
        <div id="messages"></div>

        <!-- Logs -->
        <div class="logs" id="logs">{{ logs }}</div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // DOM elements
            const form = document.getElementById("stream-form");
            const inputType = document.getElementById("input_type");
            const videoSelection = document.getElementById("video-selection");
            const srtInput = document.getElementById("srt-input");
            const encoder = document.getElementById("encoder");
            const preset = document.getElementById("preset");
            const encoderHelp = document.getElementById("encoder-help");
            const presetHelp = document.getElementById("preset-help");
            const statusDot = document.getElementById("status-dot");
            const statsText = document.getElementById("stats-text");
            const logsEl = document.getElementById("logs");
            const toggleBtn = document.getElementById("toggle-btn");
            const toggleText = document.getElementById("toggle-text");
            const messagesDiv = document.getElementById("messages");

            const currentPreset = "{{ form.preset }}";

            // Preset configurations
            const PRESET_OPTIONS = {
                "libx264": {
                    "ultrafast": "Ultra Fast (lowest quality)",
                    "superfast": "Super Fast",
                    "veryfast": "Very Fast",
                    "faster": "Faster",
                    "fast": "Fast",
                    "medium": "Medium (balanced)",
                    "slow": "Slow (better quality)",
                    "slower": "Slower",
                    "veryslow": "Very Slow (best quality)"
                },
                "h264_nvenc": {
                    "p1": "P1 (fastest)",
                    "p2": "P2",
                    "p3": "P3",
                    "p4": "P4 (balanced)",
                    "p5": "P5",
                    "p6": "P6",
                    "p7": "P7 (best quality)",
                    "ll": "Low Latency",
                    "llhp": "LL High Performance",
                    "llhq": "LL High Quality"
                },
                "h264_vaapi": {
                    "medium": "Medium (default)"
                }
            };

            const DEFAULT_PRESETS = {
                "libx264": "medium",
                "h264_nvenc": "p4",
                "h264_vaapi": "medium"
            };

            const ENCODER_HELP = {
                "libx264": "CPU encoding: slower presets = better quality",
                "h264_nvenc": "NVIDIA GPU encoding: P1-P7 for speed→quality, LL* for low latency",
                "h264_vaapi": "Intel GPU encoding: efficient for streaming"
            };

            // Utility functions
            function showMessage(message, type = 'danger') {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" aria-label="Close" onclick="this.parentElement.remove()"></button>
                `;
                messagesDiv.appendChild(alertDiv);

                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }

            function clearMessages() {
                messagesDiv.innerHTML = '';
            }

            function validateForm() {
                const streamKey = document.getElementById('stream_key').value.trim();
                const bitrate = document.getElementById('bitrate').value.trim();
                const inputTypeVal = inputType.value;
                const srtUrl = document.getElementById('srt_url').value.trim();

                if (!streamKey) {
                    showMessage('Stream key is required');
                    return false;
                }

                if (!bitrate.match(/^\d+k?$/)) {
                    showMessage('Invalid bitrate format. Use format like "2500k" or "2500"');
                    return false;
                }

                if (inputTypeVal === 'srt' && !srtUrl) {
                    showMessage('SRT/RTMP input URL is required when using stream input');
                    return false;
                }

                return true;
            }

            function toggleInputDisplay() {
                if (inputType.value === "file") {
                    videoSelection.style.display = "block";
                    srtInput.style.display = "none";
                } else {
                    videoSelection.style.display = "none";
                    srtInput.style.display = "block";
                }
            }

            function populatePresets() {
                const encoderVal = encoder.value;
                const options = PRESET_OPTIONS[encoderVal] || {};
                
                preset.innerHTML = "";
                
                Object.entries(options).forEach(([value, label]) => {
                    const option = document.createElement("option");
                    option.value = value;
                    option.textContent = label;
                    preset.appendChild(option);
                });

                // Set default preset
                const defaultPreset = DEFAULT_PRESETS[encoderVal] || "medium";
                const targetPreset = options[currentPreset] ? currentPreset : defaultPreset;
                preset.value = targetPreset;

                // Update help text
                encoderHelp.textContent = ENCODER_HELP[encoderVal] || "";
                presetHelp.textContent = `Selected: ${options[preset.value] || preset.value}`;
            }

            function updateStats(data) {
                if (data.running) {
                    const uptime = data.uptime ? Math.floor(data.uptime / 60) : 0;
                    const restarts = data.restarts || 0;
                    statsText.textContent = `Streaming • ${uptime}m uptime • ${restarts} restarts`;
                } else {
                    const videoCount = data.video_count || 0;
                    statsText.textContent = `Ready to stream • ${videoCount} videos available`;
                }
            }

            // API functions
            async function pollStatus() {
                try {
                    const response = await fetch("/status");
                    const data = await response.json();
                    
                    updateStats(data);
                    
                    if (data.running) {
                        statusDot.classList.remove("offline");
                        statusDot.classList.add("online");
                        statusDot.title = "Streaming";
                        toggleText.textContent = "Stop Stream";
                        toggleBtn.classList.remove("btn-start");
                        toggleBtn.classList.add("btn-stop");
                    } else {
                        statusDot.classList.remove("online");
                        statusDot.classList.add("offline");
                        statusDot.title = "Offline";
                        toggleText.textContent = "Start Stream";
                        toggleBtn.classList.remove("btn-stop");
                        toggleBtn.classList.add("btn-start");
                    }
                } catch (error) {
                    console.error("Failed to get status:", error);
                }
            }

            async function pollLogs() {
                try {
                    const response = await fetch("/logs");
                    const data = await response.json();
                    const lines = data.lines || [];
                    
                    logsEl.textContent = lines.join("\n");
                    logsEl.scrollTop = logsEl.scrollHeight;
                } catch (error) {
                    console.error("Failed to get logs:", error);
                }
            }

            // Event listeners
            toggleBtn.addEventListener("click", async function() {
                if (!validateForm()) return;
                
                clearMessages();

                try {
                    toggleBtn.disabled = true;
                    toggleBtn.classList.add("loading");
                    
                    const formData = new FormData(form);
                    const response = await fetch("/toggle", {
                        method: "POST",
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        showMessage(data.error || "Failed to toggle stream", "danger");
                    } else {
                        showMessage(data.message || "Stream toggled", "success");
                    }
                    
                    // Immediately update status
                    await pollStatus();
                    await pollLogs();
                    
                } catch (error) {
                    showMessage("Network error: " + error.message, "danger");
                } finally {
                    toggleBtn.disabled = false;
                    toggleBtn.classList.remove("loading");
                }
            });

            encoder.addEventListener("change", populatePresets);
            inputType.addEventListener("change", toggleInputDisplay);
            
            preset.addEventListener("change", function() {
                const options = PRESET_OPTIONS[encoder.value] || {};
                presetHelp.textContent = `Selected: ${options[preset.value] || preset.value}`;
            });

            // Global functions
            window.clearLogs = function() {
                logsEl.textContent = "";
            };

            // Initialize
            toggleInputDisplay();
            populatePresets();
            
            // Start polling
            pollStatus();
            pollLogs();
            setInterval(pollStatus, 3000);
            setInterval(pollLogs, 2000);
        });
    </script>
</body>
</html>
