<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rerun</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background-color: #0f1113; color: #e6e8ea; }
  .container { max-width: 840px; margin-top: 40px; padding: 28px; background-color: #171a1d; border-radius: 14px; box-shadow: 0 6px 24px rgba(0,0,0,0.4); }
  h1 { font-size: 1.6rem; }
  .form-label { font-weight: 600; }
  .hint { font-size: .85rem; color: #9aa0a6; }
  .btn-start { background-color: #1a7f37; color: #fff; }
  .btn-stop  { background-color: #c0353a; color: #fff; }
  select, input { background-color: #1f2327; color: #e6e8ea; border: 1px solid #2c3136; }
  .logs { background-color: #111417; border: 1px solid #2c3136; padding: 10px; height: 220px; overflow-y: auto; border-radius: 8px; margin-top: 16px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; white-space: pre-wrap; }
  .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-left: 8px; }
  .dot.online { background-color: #1a7f37; box-shadow: 0 0 8px rgba(26,127,55,.8); }
  .dot.offline { background-color: #555b61; }
</style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="m-0">Rerun 24/7 <span id="status-dot" class="dot offline" title="Status"></span></h1>
    <span class="hint">GPU: NVIDIA (NVENC) • Intel (VAAPI/QSV)</span>
  </div>

  <form id="form" class="mt-2">
    <div class="row g-3">
      <div class="col-12">
        <label for="stream_key" class="form-label">Stream Key / Output URL</label>
        <input type="text" class="form-control" id="stream_key" name="stream_key"
               placeholder="Twitch/YouTube RTMP or custom SRT link"
               value="{{ form.stream_key }}">
        <div class="hint mt-1">Examples: rtmp://live.twitch.tv/app/KEY or srt://host:port?streamid=…</div>
      </div>
      <div class="col-md-4">
        <label for="bitrate" class="form-label">Video Bitrate</label>
        <input type="text" class="form-control" id="bitrate" name="bitrate"
               placeholder="2500k" value="{{ form.bitrate }}">
      </div>
      <div class="col-md-4">
        <label for="input_type" class="form-label">Input Type</label>
        <select class="form-select" id="input_type" name="input_type">
          <option value="file" {% if form.input_type=='file' %}selected{% endif %}>Local Video</option>
          <option value="srt"  {% if form.input_type=='srt' %}selected{% endif %}>SRT / RTMP URL</option>
        </select>
      </div>
      <div class="col-md-4">
        <label for="encoder" class="form-label">Video Encoder</label>
        <select class="form-select" id="encoder" name="encoder">
          <option value="libx264" {% if form.encoder=='libx264' %}selected{% endif %}>CPU (libx264)</option>
          <option value="h264_nvenc" {% if form.encoder=='h264_nvenc' %}selected{% endif %}>NVIDIA GPU (NVENC)</option>
          <option value="h264_qsv" {% if form.encoder=='h264_qsv' %}selected{% endif %}>Intel iGPU (QSV)</option>
          <option value="h264_vaapi" {% if form.encoder=='h264_vaapi' %}selected{% endif %}>Intel/AMD (VAAPI)</option>
        </select>
        <div class="hint mt-1" id="preset-help"></div>
      </div>
      <div class="col-md-8" id="video-div">
        <label for="video" class="form-label">Select Video</label>
        <select class="form-select" id="video" name="video">
          {% for v in videos %}
            <option value="{{v}}" {% if form.video==v %}selected{% endif %}>{{v}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-8" id="srt-div">
        <label for="srt_url" class="form-label">SRT / RTMP URL</label>
        <input type="text" class="form-control" id="srt_url" name="srt_url"
               placeholder="srt://host:port?streamid=..." value="{{ form.srt_url }}">
      </div>
      <div class="col-md-4">
        <label for="preset" class="form-label">Encoder Preset</label>
        <select class="form-select" id="preset" name="preset"></select>
      </div>
    </div>
    <div class="d-flex gap-2 mt-3">
      <button id="toggle-btn" type="button" class="btn btn-start">Start Stream</button>
    </div>
  </form>

  <div class="logs mt-3" id="logs">{{ logs }}</div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const form       = document.getElementById("form");
  const inputType  = document.getElementById("input_type");
  const videoDiv   = document.getElementById("video-div");
  const srtDiv     = document.getElementById("srt-div");
  const encoder    = document.getElementById("encoder");
  const preset     = document.getElementById("preset");
  const presetHelp = document.getElementById("preset-help");
  const statusDot  = document.getElementById("status-dot");
  const logsEl     = document.getElementById("logs");
  const toggleBtn  = document.getElementById("toggle-btn");
  const currentPreset = "{{ form.preset }}";

  function toggleInputs() {
    if (inputType.value === "file") {
      videoDiv.style.display = "block";
      srtDiv.style.display   = "none";
    } else {
      videoDiv.style.display = "none";
      srtDiv.style.display   = "block";
    }
  }

  const PRESET_OPTIONS = {
    "libx264": {
      "ultrafast":"Ultra fast (lowest quality)",
      "superfast":"Super fast",
      "veryfast":"Very fast",
      "faster":"Faster",
      "fast":"Fast",
      "medium":"Medium (default)",
      "slow":"Slow",
      "slower":"Slower",
      "veryslow":"Very slow (highest quality)",
      "placebo":"Placebo"
    },
    "h264_nvenc": {
      "p1":"P1 (fastest, lowest quality)","p2":"P2","p3":"P3","p4":"P4 (default)",
      "p5":"P5","p6":"P6","p7":"P7","ll":"Low latency","llhp":"LL High Perf","llhq":"LL High Quality",
      "hp":"High Perf","hq":"High Quality","bd":"Blu-ray","lossless":"Lossless","losslesshp":"Lossless HP"
    },
    "h264_qsv": { "veryfast":"Very fast","faster":"Faster","fast":"Fast","medium":"Medium","slow":"Slow" },
    "h264_vaapi": { "medium":"Medium" }
  };
  const DEFAULT_FOR_ENCODER = {
    "libx264":"medium","h264_nvenc":"p4","h264_qsv":"medium","h264_vaapi":"medium"
  };
  const PRESET_HELP = {
    "libx264":"CPU presets trade speed vs quality; slower = better compression.",
    "h264_nvenc":"p1..p7 are speed→quality; ll* for latency.",
    "h264_qsv":"Quick Sync presets trade speed vs quality.",
    "h264_vaapi":"Preset support varies; bitrate dominates."
  };

  function populatePresets() {
    const enc = encoder.value;
    const options = PRESET_OPTIONS[enc] || {};
    preset.innerHTML = "";
    Object.entries(options).forEach(([val,label]) => {
      const opt = document.createElement("option");
      opt.value = val; opt.text = label;
      preset.appendChild(opt);
    });
    const want = (options[currentPreset] ? currentPreset : (DEFAULT_FOR_ENCODER[enc] || "medium"));
    preset.value = want;
    presetHelp.textContent = PRESET_HELP[enc] || "";
  }

  async function pollStatus() {
    try {
      const r = await fetch("/status");
      const j = await r.json();
      if (j.running) {
        statusDot.classList.remove("offline");
        statusDot.classList.add("online");
        statusDot.title = "Streaming";
        toggleBtn.textContent = "Stop Stream";
        toggleBtn.classList.remove("btn-start");
        toggleBtn.classList.add("btn-stop");
      } else {
        statusDot.classList.remove("online");
        statusDot.classList.add("offline");
        statusDot.title = "Stopped";
        toggleBtn.textContent = "Start Stream";
        toggleBtn.classList.remove("btn-stop");
        toggleBtn.classList.add("btn-start");
      }
    } catch (e) {}
  }

  async function pollLogs() {
    try {
      const r = await fetch("/logs");
      const j = await r.json();
      logsEl.textContent = (j.lines || []).join("\n");
      logsEl.scrollTop = logsEl.scrollHeight;
    } catch (e) {}
  }

  toggleBtn.addEventListener("click", async function() {
    try {
      toggleBtn.disabled = true;
      const fd = new FormData(form);
      const r = await fetch("/toggle", { method: "POST", body: fd });
      const j = await r.json();
      if (!r.ok) {
        logsEl.textContent = (j && j.error) ? j.error : "Failed to toggle.";
      } else {
        logsEl.textContent = (j.message || "") + "\n" + logsEl.textContent;
      }
      await pollStatus();
      await pollLogs();
    } catch (e) {
      // no-op
    } finally {
      toggleBtn.disabled = false;
    }
  });

  encoder.addEventListener("change", populatePresets);
  inputType.addEventListener("change", toggleInputs);
  toggleInputs();
  populatePresets();

  setInterval(pollStatus, 2000);
  setInterval(pollLogs, 2000);
  pollStatus();
  pollLogs();
});
</script>
</body>
</html>
